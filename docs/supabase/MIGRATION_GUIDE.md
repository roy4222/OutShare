# ğŸš€ Supabase è³‡æ–™é·ç§»å®ŒæˆæŒ‡å—

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. è³‡æ–™åº«çµæ§‹ (Migrations)
å·²å»ºç«‹ä»¥ä¸‹ SQL migration æª”æ¡ˆæ–¼ `supabase/migrations/`ï¼š

- âœ… `001_create_trip_gear_table.sql` - å»ºç«‹ trip_gear ä¸­é–“è¡¨
- âœ… `002_add_trip_slug.sql` - ç‚º trip è¡¨æ·»åŠ  slug æ¬„ä½
- âœ… `003_seed_initial_data.sql` - åŒ¯å…¥åˆå§‹è³‡æ–™ï¼ˆ4 å€‹æ—…ç¨‹ã€12 å€‹è£å‚™ï¼‰
- âœ… `004_setup_rls_policies.sql` - è¨­å®š RLS å®‰å…¨æ”¿ç­–

### 2. è³‡æ–™å­˜å–å±¤
å·²å»ºç«‹ Supabase æœå‹™å±¤æ–¼ `lib/services/supabase/`ï¼š

- âœ… `mapper.ts` - è³‡æ–™è½‰æ›å‡½å¼ï¼ˆDB Row â†’ Domain Modelï¼‰
- âœ… `equipment.service.ts` - è£å‚™è³‡æ–™æŸ¥è©¢æœå‹™
- âœ… `trips.service.ts` - æ—…ç¨‹è³‡æ–™æŸ¥è©¢æœå‹™
- âœ… `index.ts` - çµ±ä¸€åŒ¯å‡º

### 3. React Hooks
å·²æ›´æ–°/å»ºç«‹ä»¥ä¸‹ hooksï¼š

- âœ… `useEquipment.ts` - å¾ Supabase ç²å–è£å‚™è³‡æ–™ï¼ˆå·²æ›´æ–°ï¼‰
- âœ… `useTripStats.ts` - å¾ Supabase è¨ˆç®—æ—…ç¨‹çµ±è¨ˆï¼ˆå·²æ›´æ–°ï¼‰
- âœ… `useTrips.ts` - å¾ Supabase ç²å–æ—…ç¨‹åˆ—è¡¨ï¼ˆæ–°å»ºï¼‰

### 4. å‰ç«¯çµ„ä»¶
å·²æ›´æ–°ä»¥ä¸‹çµ„ä»¶ï¼š

- âœ… `app/profile/page.tsx` - ä½¿ç”¨æ–°çš„ useTrips hook
- âœ… `components/features/trips/TripList.tsx` - ç°¡åŒ–é‚è¼¯
- âœ… `components/features/trips/TripItemWithStats.tsx` - æ–°å»ºçµ„ä»¶è™•ç†çµ±è¨ˆ

### 5. éœæ…‹è³‡æ–™æª”æ¡ˆ
å·²æ¨™è¨˜ç‚ºå»¢æ£„ä½†ä¿ç•™ä½œç‚ºå‚™ä»½ï¼š

- âœ… `data/trips.ts` - å·²åŠ è¨»è§£èªªæ˜å·²é·ç§»
- âœ… `data/equiment.ts` - å·²åŠ è¨»è§£èªªæ˜å·²é·ç§»

## ğŸ“‹ æ¥ä¸‹ä¾†ä½ éœ€è¦åšçš„äº‹

### æ­¥é©Ÿ 1: åŸ·è¡Œ Migrations

**é¸é … Aï¼šé€é Supabase Dashboardï¼ˆæœ€ç°¡å–®ï¼‰**

1. ç™»å…¥ [Supabase Dashboard](https://app.supabase.com/)
2. é¸æ“‡ä½ çš„å°ˆæ¡ˆ
3. é»é¸å·¦å´é¸å–®çš„ **SQL Editor**
4. ä¾åºåŸ·è¡Œä»¥ä¸‹æª”æ¡ˆï¼ˆè¤‡è£½è²¼ä¸Šå…§å®¹å¾Œé» Runï¼‰ï¼š
   ```
   supabase/migrations/001_create_trip_gear_table.sql
   supabase/migrations/002_add_trip_slug.sql
   supabase/migrations/003_seed_initial_data.sql
   supabase/migrations/004_setup_rls_policies.sql
   ```

**é¸é … Bï¼šä½¿ç”¨ Supabase CLI**

```bash
# å¦‚æœé‚„æ²’å®‰è£ CLI
npm install -g supabase

# é€£çµåˆ°ä½ çš„å°ˆæ¡ˆ
supabase link --project-ref <your-project-ref>

# åŸ·è¡Œæ‰€æœ‰ migrations
supabase db push
```

### æ­¥é©Ÿ 2: é©—è­‰è³‡æ–™

åŸ·è¡Œä»¥ä¸‹ SQL ä¾†ç¢ºèªè³‡æ–™å·²æ­£ç¢ºåŒ¯å…¥ï¼š

```sql
-- æª¢æŸ¥è³‡æ–™æ•¸é‡
SELECT 'trips' as table_name, COUNT(*) as count FROM trip
UNION ALL
SELECT 'gear', COUNT(*) FROM gear
UNION ALL
SELECT 'trip_gear', COUNT(*) FROM trip_gear;
```

é æœŸçµæœï¼š
- trips: 4 ç­†
- gear: 12 ç­†
- trip_gear: ç´„ 40+ ç­†

### æ­¥é©Ÿ 3: ï¼ˆå¯é¸ï¼‰æ›´æ–°æ¸¬è©¦ä½¿ç”¨è€…

ç›®å‰è³‡æ–™ä½¿ç”¨çš„æ˜¯æ¸¬è©¦ä½¿ç”¨è€… IDï¼š
```
00000000-0000-0000-0000-000000000001
```

**æ­£å¼ç’°å¢ƒéƒ¨ç½²å‰ï¼Œå»ºè­°ï¼š**

1. é€é Supabase Auth å»ºç«‹çœŸå¯¦ä½¿ç”¨è€…
2. å–å¾—è©²ä½¿ç”¨è€…çš„ UUID
3. æ›´æ–°è³‡æ–™åº«ä¸­çš„ user_idï¼š

```sql
-- å‡è¨­ä½ çš„çœŸå¯¦ä½¿ç”¨è€… UUID æ˜¯ abc123...
UPDATE trip SET user_id = 'abc123...' 
WHERE user_id = '00000000-0000-0000-0000-000000000001';

UPDATE gear SET user_id = 'abc123...' 
WHERE user_id = '00000000-0000-0000-0000-000000000001';

UPDATE profiles SET id = 'abc123...' 
WHERE id = '00000000-0000-0000-0000-000000000001';
```

### æ­¥é©Ÿ 4: é‡æ–°ç”Ÿæˆ Database Typesï¼ˆå¯é¸ä½†æ¨è–¦ï¼‰

åŸ·è¡Œå¾Œï¼Œtrip_gear è¡¨æœƒåŠ å…¥åˆ°å‹åˆ¥å®šç¾©ä¸­ï¼š

```bash
npx supabase gen types typescript --project-id <your-project-id> > lib/database.types.ts
```

### æ­¥é©Ÿ 5: æ¸¬è©¦æ‡‰ç”¨ç¨‹å¼

å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨ä¸¦æ¸¬è©¦åŠŸèƒ½ï¼š

```bash
npm run dev
```

**æ¸¬è©¦é …ç›®ï¼š**
- âœ… æ—…ç¨‹åˆ—è¡¨æ˜¯å¦æ­£ç¢ºé¡¯ç¤º
- âœ… è£å‚™åˆ—è¡¨æ˜¯å¦æ­£ç¢ºé¡¯ç¤º
- âœ… æ—…ç¨‹çµ±è¨ˆè³‡æ–™ï¼ˆé‡é‡ã€åƒ¹æ ¼ï¼‰æ˜¯å¦æ­£ç¢º
- âœ… Loading ç‹€æ…‹æ˜¯å¦æ­£å¸¸é¡¯ç¤º
- âœ… éŒ¯èª¤è™•ç†æ˜¯å¦æ­£å¸¸

### æ­¥é©Ÿ 6: æª¢æŸ¥ Console æ˜¯å¦æœ‰éŒ¯èª¤

æ‰“é–‹ç€è¦½å™¨çš„é–‹ç™¼è€…å·¥å…·ï¼Œç¢ºèªæ²’æœ‰ä»¥ä¸‹éŒ¯èª¤ï¼š
- âŒ Supabase é€£ç·šéŒ¯èª¤
- âŒ è³‡æ–™æŸ¥è©¢éŒ¯èª¤
- âŒ TypeScript å‹åˆ¥éŒ¯èª¤

## ğŸ”§ troubleshooting

### å•é¡Œ 1: ã€ŒSupabase URL or Key is missingã€

**è§£æ±ºæ–¹æ³•ï¼š**
ç¢ºèª `.env.local` ä¸­æœ‰è¨­å®šï¼š
```env
NEXT_PUBLIC_SUPABASE_URL="your-project-url"
NEXT_PUBLIC_SUPABASE_ANON_KEY="your-anon-key"
```

### å•é¡Œ 2: ã€ŒRLS policy violationã€

**åŸå› ï¼š** Row Level Security é˜»æ“‹äº†æŸ¥è©¢

**è§£æ±ºæ–¹æ³•ï¼š**
1. ç¢ºèª `004_setup_rls_policies.sql` å·²åŸ·è¡Œ
2. æª¢æŸ¥ RLS æ”¿ç­–æ˜¯å¦æ­£ç¢ºï¼š
```sql
SELECT * FROM pg_policies WHERE tablename IN ('trip', 'gear', 'trip_gear');
```

### å•é¡Œ 3: è³‡æ–™æŸ¥è©¢è¿”å›ç©ºé™£åˆ—

**å¯èƒ½åŸå› ï¼š**
1. Migrations æœªåŸ·è¡Œæˆ–å¤±æ•—
2. user_id ä¸åŒ¹é…ï¼ˆå¦‚æœæœ‰è¨­å®šä½¿ç”¨è€…éæ¿¾ï¼‰

**æª¢æŸ¥æ–¹æ³•ï¼š**
```sql
-- ç›´æ¥æŸ¥è©¢è³‡æ–™åº«
SELECT * FROM trip LIMIT 5;
SELECT * FROM gear LIMIT 5;
```

### å•é¡Œ 4: Loading ç‹€æ…‹ä¸€ç›´é¡¯ç¤º

**å¯èƒ½åŸå› ï¼š**
1. Supabase é€£ç·šå•é¡Œ
2. æŸ¥è©¢é‚è¼¯éŒ¯èª¤

**æª¢æŸ¥æ–¹æ³•ï¼š**
æ‰“é–‹ Network tabï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰ Supabase API è«‹æ±‚å¤±æ•—ã€‚

## ğŸ“Š è³‡æ–™åº«æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  profiles   â”‚
â”‚  (ä½¿ç”¨è€…)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ user_id (FK)
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                    â”‚
â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”
â”‚  trip   â”‚      â”‚  gear   â”‚
â”‚ (æ—…ç¨‹)  â”‚      â”‚ (è£å‚™)  â”‚
â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
   â”‚                    â”‚
   â”‚ trip_id (FK)       â”‚ gear_id (FK)
   â”‚                    â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ trip_gear   â”‚
     â”‚ (é—œè¯è¡¨)    â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ æ¶æ§‹æ”¹é€²

### å„ªé»
1. **å¯æ“´å±•æ€§** - è³‡æ–™å­˜åœ¨è³‡æ–™åº«ï¼Œå®¹æ˜“ç®¡ç†å’Œæ›´æ–°
2. **å¤šä½¿ç”¨è€…æ”¯æ´** - æ¯å€‹ä½¿ç”¨è€…å¯ä»¥æœ‰è‡ªå·±çš„æ—…ç¨‹å’Œè£å‚™
3. **é—œè¯æŸ¥è©¢** - é€é trip_gear è¡¨ï¼Œå¯ä»¥å½ˆæ€§ç®¡ç†è£å‚™èˆ‡æ—…ç¨‹çš„é—œä¿‚
4. **å®‰å…¨æ€§** - RLS ç¢ºä¿ä½¿ç”¨è€…åªèƒ½ä¿®æ”¹è‡ªå·±çš„è³‡æ–™
5. **æ•ˆèƒ½** - ä½¿ç”¨ç´¢å¼•å’Œ JOIN æŸ¥è©¢ï¼Œæ•ˆèƒ½å„ªæ–¼å‰ç«¯éæ¿¾

### èˆ‡èˆŠæ¶æ§‹çš„å·®ç•°

| é …ç›® | èˆŠæ¶æ§‹ | æ–°æ¶æ§‹ |
|------|--------|--------|
| è³‡æ–™ä¾†æº | éœæ…‹æª”æ¡ˆ | Supabase è³‡æ–™åº« |
| é—œè¯æ–¹å¼ | å­—ä¸²é™£åˆ—åŒ¹é… title | trip_gear ä¸­é–“è¡¨ |
| ä½¿ç”¨è€…è³‡æ–™ | ç„¡å€åˆ† | æ¯å€‹ä½¿ç”¨è€…ç¨ç«‹ |
| æ›´æ–°æ–¹å¼ | ä¿®æ”¹ç¨‹å¼ç¢¼ | è³‡æ–™åº«æ“ä½œ |
| æŸ¥è©¢æ•ˆèƒ½ | å‰ç«¯éæ¿¾ | è³‡æ–™åº«æŸ¥è©¢ |

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [Migration README](../supabase/migrations/README.md) - Migrations è©³ç´°èªªæ˜
- [Supabase RLS Guide](https://supabase.com/docs/guides/auth/row-level-security)
- [å°ˆæ¡ˆæ¶æ§‹æ–‡ä»¶](./README.md)

## ğŸ¤ éœ€è¦å¹«åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°å•é¡Œï¼š
1. æª¢æŸ¥ [supabase/migrations/README.md](../supabase/migrations/README.md) çš„å¸¸è¦‹å•é¡Œ
2. æŸ¥çœ‹ Supabase Dashboard çš„ Logs
3. æª¢æŸ¥ç€è¦½å™¨ Console çš„éŒ¯èª¤è¨Šæ¯

---

**é·ç§»å®Œæˆæ—¥æœŸï¼š** 2025-10-18  
**ç‰ˆæœ¬ï¼š** 1.0.0  
**è² è²¬äººï¼š** AI Assistant

