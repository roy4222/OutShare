# ğŸ¯ Supabase åˆ° Prisma é‡æ§‹ææ¡ˆ - åŸ·è¡Œæ‘˜è¦

## ğŸ“‹ ææ¡ˆæ¦‚è¿°

**è®Šæ›´ ID**: `refactor-supabase-to-prisma`  
**ç‹€æ…‹**: â³ å¾…æ‰¹å‡†  
**é è¨ˆå·¥æ™‚**: 6-8 å¤©  
**å½±éŸ¿ç¯„åœ**: ğŸ”´ **é‡å¤§è®Šæ›´ (Breaking Changes)**

---

## ğŸ¯ ç›®æ¨™

å°‡å°ˆæ¡ˆçš„è³‡æ–™å­˜å–å±¤å¾ **Supabase SDK** å®Œå…¨é·ç§»åˆ° **Prisma ORM**ï¼ŒåŒæ™‚ä¿ç•™ Supabase çš„èº«ä»½é©—è­‰æœå‹™ã€‚

### ç‚ºä»€éº¼è¦åšé€™å€‹æ”¹è®Šï¼Ÿ

1. **ç°¡åŒ–æ¶æ§‹** - ç›®å‰åŒæ™‚ä½¿ç”¨ Supabase SDK å’Œæº–å‚™ç”¨ Prismaï¼Œé€ æˆæ··äº‚
2. **æå‡å‹åˆ¥å®‰å…¨** - Prisma æä¾›å®Œæ•´çš„ TypeScript å‹åˆ¥æ¨å°
3. **æœ¬åœ°é–‹ç™¼** - ä½¿ç”¨ Docker é‹è¡Œæœ¬åœ° Supabaseï¼Œç„¡éœ€ä¾è³´é›²ç«¯
4. **é™ä½æˆæœ¬** - æ¸›å°‘å°é›²ç«¯æœå‹™çš„ä¾è³´
5. **æ›´å¥½çš„ ORM** - Prisma çš„æŸ¥è©¢ API æ›´ç¾ä»£ã€æ›´æ˜“ç”¨

---

## ğŸ—ï¸ æ¶æ§‹è®Šæ›´

### ä¹‹å‰ï¼ˆç¾ç‹€ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   React Components  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  lib/services/supabase/             â”‚
â”‚  - trips.service.ts                 â”‚
â”‚  - equipment.service.ts             â”‚
â”‚  (ä½¿ç”¨ Supabase SDK)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase Cloud                     â”‚
â”‚  - PostgreSQL                       â”‚
â”‚  - Auth                             â”‚
â”‚  - RLS                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¹‹å¾Œï¼ˆç›®æ¨™ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   React Components  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ lib/services/prisma/  â”‚   â”‚ lib/supabase/    â”‚
â”‚ - trips.service.ts    â”‚   â”‚ (åƒ… Auth)        â”‚
â”‚ - equipment.service.tsâ”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ (ä½¿ç”¨ Prisma Client)  â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                    â”‚ Supabase Auth    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ (OAuth, Session) â”‚
â”‚ Local Supabase        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ (Docker)              â”‚
â”‚ - PostgreSQL          â”‚
â”‚ - Auth (local dev)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ ä¸»è¦è®Šæ›´

### âœ… ä¿ç•™çš„éƒ¨åˆ†
- âœ… **Supabase Auth** - ç¹¼çºŒä½¿ç”¨ Google OAuthã€Session ç®¡ç†
- âœ… **è³‡æ–™åº« Schema** - ä¸æ”¹è®Šç¾æœ‰çš„è³‡æ–™è¡¨çµæ§‹
- âœ… **å‰ç«¯ UI** - çµ„ä»¶ä»‹é¢ä¸è®Š
- âœ… **éƒ¨ç½²å¹³å°** - ä»ä½¿ç”¨ Cloudflare Workers

### ğŸ”„ é‡æ§‹çš„éƒ¨åˆ†
- ğŸ”„ **è³‡æ–™å­˜å–å±¤** - `lib/services/supabase/` â†’ `lib/services/prisma/`
- ğŸ”„ **å‹åˆ¥å®šç¾©** - ç§»é™¤ `lib/database.types.ts`ï¼Œæ”¹ç”¨ Prisma ç”Ÿæˆ
- ğŸ”„ **React Hooks** - æ›´æ–°ç‚ºä½¿ç”¨ Prisma services
- ğŸ”„ **é–‹ç™¼ç’°å¢ƒ** - æ”¹ç”¨æœ¬åœ° Supabase (Docker)
- ğŸ”„ **æª”æ¡ˆå„²å­˜** - Supabase Storage â†’ Cloudflare R2 â­

### âŒ ç§»é™¤çš„éƒ¨åˆ†
- âŒ Supabase SDK çš„è³‡æ–™æŸ¥è©¢åŠŸèƒ½ï¼ˆ`supabase.from('table')`ï¼‰
- âŒ `lib/database.types.ts`
- âŒ å°é›²ç«¯ Supabase è³‡æ–™åº«çš„ç›´æ¥ä¾è³´
- âŒ Supabase Storage æª”æ¡ˆä¸Šå‚³é‚è¼¯

---

## ğŸ“Š å½±éŸ¿åˆ†æ

### éœ€è¦ä¿®æ”¹çš„æª”æ¡ˆï¼ˆç´„ 15-20 å€‹ï¼‰

#### æ ¸å¿ƒæœå‹™å±¤ï¼ˆæ–°å»º/é‡å¯«ï¼‰
- âœï¸ `lib/prisma.ts` - **æ–°å»º** Prisma Client å–®ä¾‹
- âœï¸ `lib/services/prisma/trips.service.ts` - **æ–°å»º**
- âœï¸ `lib/services/prisma/equipment.service.ts` - **æ–°å»º**
- âœï¸ `lib/services/prisma/profiles.service.ts` - **æ–°å»º**
- âœï¸ `prisma/schema.prisma` - **æ–°å»º** Prisma schema
- âœï¸ `app/api/upload/route.ts` - **æ–°å»º** R2 æª”æ¡ˆä¸Šå‚³ API â­

#### React Hooksï¼ˆæ›´æ–°ï¼‰
- ğŸ”„ `lib/hooks/useTrips.ts`
- ğŸ”„ `lib/hooks/useEquipment.ts`
- ğŸ”„ `lib/hooks/useTripStats.ts`

#### å‰ç«¯çµ„ä»¶ï¼ˆæ›´æ–°ï¼‰
- ğŸ”„ `app/profile/page.tsx`
- ğŸ”„ `app/GearDashboard/page.tsx`
- ğŸ”„ å…¶ä»–ä½¿ç”¨è³‡æ–™çš„é é¢

#### Auth ç›¸é—œï¼ˆç°¡åŒ–ï¼‰
- ğŸ”„ `lib/supabase/client.ts` - ä¿ç•™ä½†åŠ è¨»è§£
- ğŸ”„ `lib/supabase/server.ts` - ä¿ç•™ä½†åŠ è¨»è§£

#### é…ç½®æª”æ¡ˆï¼ˆæ›´æ–°ï¼‰
- ğŸ”„ `package.json` - æ–°å¢ Prisma scripts
- ğŸ”„ `.env.local.example` - æ›´æ–°ç’°å¢ƒè®Šæ•¸ï¼ˆå« R2ï¼‰ â­
- ğŸ”„ `wrangler.toml` - R2 bucket ç¶å®š â­
- ğŸ”„ `supabase/config.toml` - **æ–°å»º**

#### éœ€è¦åˆªé™¤çš„æª”æ¡ˆ
- âŒ `lib/services/supabase/` æ•´å€‹ç›®éŒ„
- âŒ `lib/database.types.ts`

---

## ğŸ“ å¯¦ä½œè¨ˆç•«ï¼ˆ11 å€‹éšæ®µï¼‰

| éšæ®µ | ä»»å‹™ | é è¨ˆæ™‚é–“ | é¢¨éšª |
|------|------|---------|------|
| 1 | ç’°å¢ƒè¨­å®šèˆ‡åŸºç¤å»ºè¨­ï¼ˆå« R2ï¼‰ â­ | 1 å¤© | ğŸŸ¡ ä¸­ |
| 2 | è³‡æ–™æœå‹™å±¤é‡æ§‹ | 1.5 å¤© | ğŸŸ¡ ä¸­ |
| 3 | React Hooks æ›´æ–° | 1 å¤© | ğŸŸ¢ ä½ |
| 4 | å‰ç«¯çµ„ä»¶æ›´æ–° | 1 å¤© | ğŸŸ¡ ä¸­ |
| 5 | API Routes æ›´æ–°èˆ‡æª”æ¡ˆä¸Šå‚³ â­ | 1 å¤© | ğŸŸ¡ ä¸­ |
| 6 | Auth ç›¸é—œç¨‹å¼ç¢¼ç°¡åŒ– | 0.5 å¤© | ğŸŸ¢ ä½ |
| 7 | æ¸…ç†èˆŠç¨‹å¼ç¢¼ | 0.5 å¤© | ğŸŸ¢ ä½ |
| 8 | æ¸¬è©¦èˆ‡é©—è­‰ | 1 å¤© | ğŸ”´ é«˜ |
| 9 | æ–‡ä»¶æ›´æ–° | 0.5 å¤© | ğŸŸ¢ ä½ |
| 10 | éƒ¨ç½²æº–å‚™ï¼ˆå«åœ–ç‰‡é·ç§»ï¼‰ â­ | 1 å¤© | ğŸŸ¡ ä¸­ |
| 11 | æœ€çµ‚æª¢æŸ¥ | 0.5 å¤© | ğŸŸ¡ ä¸­ |

**ç¸½è¨ˆ**: 9.5 å¤©ï¼ˆç´„ 2 é€±ï¼‰

---

## âš ï¸ é¢¨éšªèˆ‡ç·©è§£æªæ–½

### ğŸ”´ é«˜é¢¨éšª

#### 1. å¤±å»è³‡æ–™åº« RLS ä¿è­·
- **é¢¨éšª**: Prisma ä¸æ”¯æ´ PostgreSQL RLSï¼Œå®Œå…¨ä¾è³´æ‡‰ç”¨å±¤æ¬Šé™æª¢æŸ¥
- **ç·©è§£**: 
  - åœ¨æ¯å€‹ service å‡½æ•¸åš´æ ¼æª¢æŸ¥ `userId`
  - æ’°å¯«å®Œæ•´çš„å–®å…ƒæ¸¬è©¦
  - ä¿ç•™è³‡æ–™åº«çš„ RLS policies ä½œç‚ºé¡å¤–é˜²è­·

#### 2. Migration å¯èƒ½å¼•å…¥ bugs
- **é¢¨éšª**: å¤§é‡ç¨‹å¼ç¢¼é‡å¯«ï¼Œå¯èƒ½éºæ¼é‚Šç•Œæƒ…æ³
- **ç·©è§£**:
  - åˆ†éšæ®µé·ç§»ï¼ˆtrips â†’ gear â†’ profilesï¼‰
  - æ¯éšæ®µå®Œæˆå¾Œé€²è¡Œå®Œæ•´åŠŸèƒ½æ¸¬è©¦
  - ä¿ç•™èˆŠç¨‹å¼ç¢¼ä½œç‚ºåƒè€ƒç›´åˆ°å…¨éƒ¨æ¸¬è©¦é€šé

### ğŸŸ¡ ä¸­é¢¨éšª

#### 3. éƒ¨ç½²è¤‡é›œåº¦å¢åŠ 
- **é¢¨éšª**: éœ€è¦ç¢ºä¿ç”Ÿç”¢ç’°å¢ƒ `DATABASE_URL` æ­£ç¢ºé…ç½®
- **ç·©è§£**:
  - è©³ç´°çš„éƒ¨ç½²æ–‡ä»¶
  - å…ˆåœ¨æ¸¬è©¦ç’°å¢ƒé©—è­‰
  - å¯ç¹¼çºŒä½¿ç”¨ Supabase é›²ç«¯ PostgreSQLï¼ˆåªæ˜¯é€é Prisma é€£æ¥ï¼‰

#### 4. å¤±å» Realtime åŠŸèƒ½
- **é¢¨éšª**: æœªä¾†è‹¥éœ€è¦å³æ™‚åŒæ­¥æœƒè¼ƒå›°é›£
- **ç·©è§£**: 
  - ç›®å‰æœªä½¿ç”¨ Realtimeï¼Œæš«ä¸å½±éŸ¿
  - æœªä¾†å¯ç”¨ WebSocket æˆ– SSE è‡ªè¡Œå¯¦ç¾

---

## âœ… é©—è­‰æ¨™æº–

### åŠŸèƒ½æ¸¬è©¦ Checklist

- [ ] ä½¿ç”¨è€…å¯ä»¥æ­£å¸¸ç™»å…¥/ç™»å‡ºï¼ˆGoogle OAuthï¼‰
- [ ] å¯ä»¥å»ºç«‹ã€è®€å–ã€æ›´æ–°ã€åˆªé™¤ Trips
- [ ] å¯ä»¥å»ºç«‹ã€è®€å–ã€æ›´æ–°ã€åˆªé™¤ Gear
- [ ] å¯ä»¥æ›´æ–° Profile
- [ ] Trip èˆ‡ Gear çš„é—œè¯æ­£å¸¸é‹ä½œ
- [ ] æ¬Šé™æ§åˆ¶æ­£ç¢ºï¼ˆä½¿ç”¨è€…åªèƒ½ä¿®æ”¹è‡ªå·±çš„è³‡æ–™ï¼‰
- [ ] å…¬é–‹é é¢ï¼ˆ`[username]`ï¼‰æ­£å¸¸é¡¯ç¤º
- [ ] Profile é é¢å®Œæ•´åŠŸèƒ½é‹ä½œ
- [ ] Gear Dashboard å®Œæ•´åŠŸèƒ½é‹ä½œ

### æŠ€è¡“é©—è­‰ Checklist

- [ ] `npm run build` æˆåŠŸï¼Œç„¡ TypeScript éŒ¯èª¤
- [ ] `npm run lint` é€šé
- [ ] æ‰€æœ‰ Prisma migrations å¯æ­£å¸¸åŸ·è¡Œ
- [ ] æœ¬åœ° Supabase å¯æ­£å¸¸å•Ÿå‹•ï¼ˆ`npx supabase start`ï¼‰
- [ ] ç„¡ N+1 æŸ¥è©¢å•é¡Œ
- [ ] æŸ¥è©¢æ•ˆèƒ½èˆ‡ä¹‹å‰ç›¸ç•¶æˆ–æ›´å¥½

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

å»ºç«‹å¾Œçš„æ–‡ä»¶çµæ§‹ï¼š

```
docs/
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ PRISMA_GUIDE.md         (æ–°å»º)
â”‚   â”œâ”€â”€ LOCAL_SETUP.md          (æ–°å»º)
â”‚   â””â”€â”€ MIGRATION_HISTORY.md    (æ›´æ–°)
â”œâ”€â”€ Auth/
â”‚   â””â”€â”€ AUTH_ARCHITECTURE.md    (æ›´æ–°)
â””â”€â”€ README.md                   (æ›´æ–°)

openspec/
â””â”€â”€ changes/
    â””â”€â”€ refactor-supabase-to-prisma/
        â”œâ”€â”€ proposal.md         âœ… å·²å»ºç«‹
        â”œâ”€â”€ design.md           âœ… å·²å»ºç«‹
        â”œâ”€â”€ tasks.md            âœ… å·²å»ºç«‹
        â”œâ”€â”€ SUMMARY.md          âœ… å·²å»ºç«‹
        â””â”€â”€ specs/
            â””â”€â”€ database-layer/
                â””â”€â”€ spec.md     âœ… å·²å»ºç«‹
```

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡Œå‹•

### ç«‹å³åŸ·è¡Œï¼ˆåœ¨æ‰¹å‡†å¾Œï¼‰
1. å®‰è£ä¾è³´ï¼š`npm install -D prisma @prisma/client supabase`
2. åˆå§‹åŒ–æœ¬åœ° Supabaseï¼š`npx supabase init && npx supabase start`
3. å»ºç«‹ Prisma schemaï¼š`npx prisma init && npx prisma db pull`
4. é–‹å§‹å¯¦ä½œ Phase 2ï¼ˆè³‡æ–™æœå‹™å±¤ï¼‰

### âœ… å·²æ±ºç­–çš„å•é¡Œ
- âœ… **ç”Ÿç”¢ç’°å¢ƒè³‡æ–™åº«**: ç¹¼çºŒä½¿ç”¨ Supabase PostgreSQLï¼ˆé€é Prisma é€£æ¥ï¼‰
- âœ… **æª”æ¡ˆå„²å­˜**: é·ç§»åˆ° Cloudflare R2 â­
  - ç†ç”±ï¼šèˆ‡ Cloudflare Workers åŸç”Ÿæ•´åˆï¼Œé›¶å‡ºå£æµé‡è²»
  - å¯¦æ–½ï¼šPhase 1 å°±è¦åŠƒ R2 bucket è¨­å®š
- âœ… **Migration å·¥å…·**: çµ±ä¸€ä½¿ç”¨ Prisma Migrate
- âœ… **Auth åŒæ­¥**: ä½¿ç”¨ Supabase Database Trigger è‡ªå‹•å»ºç«‹ profile

---

## ğŸ“ è¯çµ¡èˆ‡æ”¯æ´

å¦‚æœ‰ä»»ä½•å•é¡Œæˆ–éœ€è¦å”åŠ©ï¼Œè«‹ï¼š
1. æŸ¥é–± `design.md` ä¸­çš„æŠ€è¡“æ±ºç­–
2. åƒè€ƒ `tasks.md` ä¸­çš„è©³ç´°æ­¥é©Ÿ
3. é–±è®€ `specs/database-layer/spec.md` äº†è§£è¦æ ¼è¦æ±‚

---

**å»ºç«‹æ—¥æœŸ**: 2025-10-21  
**OpenSpec é©—è­‰**: âœ… é€šé (`openspec validate refactor-supabase-to-prisma --strict`)  
**æº–å‚™ç‹€æ…‹**: âœ… å¯ä»¥é–‹å§‹å¯¦ä½œ

